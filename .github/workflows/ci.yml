name: CI
permissions:
  contents: read
concurrency:
  group: >
    ci-${{ github.workflow }}-${{
      github.event_name == 'pull_request' &&
      github.event.pull_request.number ||
      github.ref
    }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # Continue other jobs if one fails
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1.15.2
        with:
          target: ${{ matrix.target }}
          cache: true  # Built-in caching
          # toolchain, components, etc. are specified in rust-toolchain.toml

      - name: Install just
        if: matrix.os != 'windows-latest'
        uses: taiki-e/install-action@62da238c048aa0f865cc5a322082957d34e7fc1a  # v2.62.54
        with:
          tool: just

      - name: Install uv (for Python scripts and pytest)
        if: matrix.os != 'windows-latest'
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4
        with:
          version: "latest"

      - name: Install Node.js (for markdownlint and cspell)
        if: matrix.os != 'windows-latest'
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'

      - name: Install Node.js packages
        if: matrix.os != 'windows-latest'
        run: |
          npm install -g markdownlint-cli cspell

      - name: Install additional tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Install shellcheck, shfmt, and jq
          sudo apt-get update
          sudo apt-get install -y shellcheck jq

          # Install shfmt
          SHFMT_VERSION="3.7.0"
          curl -fsSL \
            "https://github.com/mvdan/sh/releases/download/v${SHFMT_VERSION}/shfmt_v${SHFMT_VERSION}_linux_amd64" \
            -o shfmt
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/

      - name: Install additional tools (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # Install shellcheck, shfmt, and jq via Homebrew
          brew install shellcheck shfmt jq

      - name: Run CI checks (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: just ci

      - name: Build and test (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cargo build --verbose --all-targets
          cargo test --lib --verbose
          cargo test --doc --verbose
