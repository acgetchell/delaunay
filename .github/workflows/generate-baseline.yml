name: Generate Performance Baseline

# Generate performance baselines for new releases
# Security: All GitHub context variables are passed through safe environment variables
# to prevent code injection attacks via malicious branch names or commit data
on:
  # Trigger on tag creation (releases)
  push:
    tags:
      - "v*"

  # Manual trigger (supports regenerating a baseline for an existing tag)
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to benchmark (e.g. v0.6.2)"
        required: true
        type: string

# Security: Define minimal required permissions
permissions:
  contents: read
  actions: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  generate-baseline:
    concurrency:
      group: generate-baseline-${{ github.ref }}
      cancel-in-progress: false
    runs-on: macos-15 # Use same runner as benchmark workflow for consistency
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Full history for tag operations

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          cache: true
          # Toolchain from rust-toolchain.toml

      - name: Install uv (Python package manager)
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "latest"

      - name: Verify uv installation
        run: uv --version

      - name: Determine target tag
        id: tag_info
        env:
          INPUT_TAG: ${{ inputs.tag }}
          REF_TYPE: ${{ github.ref_type }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          if [[ "${REF_TYPE}" = "tag" && -n "${REF_NAME}" ]]; then
            tag_name="${REF_NAME}"
          elif [[ -n "${INPUT_TAG}" ]]; then
            tag_name="${INPUT_TAG}"
          else
            echo "error: no tag provided. For workflow_dispatch you must provide inputs.tag" >&2
            exit 1
          fi

          if [[ ! "${tag_name}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "error: tag must look like vX.Y.Z (got: '${tag_name}')" >&2
            exit 1
          fi

          echo "tag_name=${tag_name}" >> "$GITHUB_OUTPUT"

      - name: Checkout target tag (code under test)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ steps.tag_info.outputs.tag_name }}
          path: target

      - name: Install target Rust toolchain (from tag)
        env:
          TAG_NAME: ${{ steps.tag_info.outputs.tag_name }}
        run: |
          set -euo pipefail

          channel="$(python3 - <<'PY'
          from pathlib import Path
          import tomllib

          data = tomllib.loads(Path('target/rust-toolchain.toml').read_text(encoding='utf-8'))
          print(data['toolchain']['channel'])
          PY
          )"

          echo "ðŸ“Œ Target tag: ${TAG_NAME}"
          echo "ðŸ¦€ Installing Rust toolchain: ${channel}"

          rustup toolchain install "${channel}" --profile minimal

      - name: Generate performance baseline
        env:
          TAG_NAME: ${{ steps.tag_info.outputs.tag_name }}
        run: |
          set -euo pipefail

          echo "ðŸš€ Generating performance baseline for tag ${TAG_NAME}"

          # Generate baseline using fixed tooling (this checkout) against the tag checkout.
          uv run benchmark-utils generate-baseline \
            --project-root target \
            --tag "${TAG_NAME}"

          echo "âœ… Baseline generated successfully"

          # Display baseline summary
          uv run benchmark-utils display-summary \
            --baseline "target/baseline-artifact/baseline_results.txt"

      - name: Prepare baseline artifact
        env:
          TAG_NAME: ${{ steps.tag_info.outputs.tag_name }}
          SAFE_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail

          # Create metadata file in the target checkout so it is included in the uploaded artifact.
          uv run benchmark-utils create-metadata \
            --tag "${TAG_NAME}" \
            --output-dir "target/baseline-artifact"

          # Extract the tag commit from the baseline file for human-readable logging.
          baseline_commit="$(python3 - <<'PY'
          from pathlib import Path
          import re

          text = Path('target/baseline-artifact/baseline_results.txt').read_text(encoding='utf-8', errors='replace')
          m = re.search(r'^Git commit:\s*(\S+)', text, flags=re.MULTILINE)
          print(m.group(1) if m else 'unknown')
          PY
          )"
          echo "BASELINE_COMMIT=${baseline_commit}" >> "$GITHUB_ENV"

          echo "ðŸ“¦ Artifact contents:"
          ls -la target/baseline-artifact/

      - name: Create safe artifact name
        id: safe_name
        env:
          TAG_NAME: ${{ steps.tag_info.outputs.tag_name }}
        run: uv run benchmark-utils sanitize-artifact-name --tag "$TAG_NAME"

      - name: Upload baseline artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ steps.safe_name.outputs.artifact_name }}
          path: target/baseline-artifact/
          retention-days: 90 # Keep baselines ~90 days (align with repo settings; adjust if needed)
          compression-level: 6 # Good balance of speed/compression

      - name: Display next steps
        env:
          TAG_NAME: ${{ steps.tag_info.outputs.tag_name }}
          SAFE_REF_TYPE: ${{ github.ref_type }}
        run: |
          set -euo pipefail

          echo "ðŸŽ‰ Performance baseline generated successfully!"
          echo ""
          echo "ðŸ“‹ Summary:"
          echo "  Tag: $TAG_NAME"
          echo "  Commit: ${BASELINE_COMMIT:-unknown}"
          echo "  Artifact: ${{ steps.safe_name.outputs.artifact_name }}"
          echo ""
          echo "ðŸ”„ The benchmark workflow will now use this baseline for:"
          echo "  â€¢ Pull request performance testing"
          echo "  â€¢ Main branch regression detection"
          echo "  â€¢ Manual performance comparisons"
          echo ""
          if [ "$SAFE_REF_TYPE" = "tag" ]; then
            echo "ðŸ’¡ This baseline is now available for tag $TAG_NAME"
          fi
